
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>What does a MyBinder.org deployment do? &#8212; Site Reliability Guide for mybinder.org 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Common problems and their solutions" href="../common_problems.html" />
    <link rel="prev" title="How to deploy a change to mybinder.org?" href="how.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<!-- Add JupyterHub styling -->
<link rel="stylesheet" href="../_static/jupyter.css" type="text/css" />
<link rel="shortcut icon" href="../_static/favicon.ico"/>


  </head><body>
<div class="rightsidebar">
    <h3>On this page</h3>
    <ul>
<li><a class="reference internal" href="#">What does a MyBinder.org deployment do?</a><ul>
<li><a class="reference internal" href="#stage-1-installing-deployment-tools">Stage 1: Installing deployment tools</a><ul>
<li><a class="reference internal" href="#step-1-install-all-the-things">Step 1: Install all the things!</a><ul>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#what-happens">What happens</a></li>
<li><a class="reference internal" href="#what-could-go-wrong">What could go wrong?</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#stage-2-configuring-deployment-tools">Stage 2: Configuring deployment tools</a><ul>
<li><a class="reference internal" href="#step-1-decrypting-secrets">Step 1: Decrypting secrets</a><ul>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#what-happens">What happens?</a></li>
<li><a class="reference internal" href="#what-could-go-wrong">What could go wrong?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-2-setting-up-helm">Step 2: Setting up Helm</a><ul>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#what-happens">What happens</a></li>
<li><a class="reference internal" href="#what-could-go-wrong">What could go wrong?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-3-tell-grafana-our-deployment-is-starting">Step 3: Tell Grafana our deployment is starting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#stage-3-deploy-to-staging">Stage 3: Deploy to staging</a><ul>
<li><a class="reference internal" href="#step-1-set-up-and-do-the-helm-upgrade">Step 1: Set up and do the helm upgrade</a><ul>
<li><a class="reference internal" href="#what-happens">What happens</a></li>
<li><a class="reference internal" href="#what-could-go-wrong">What could go wrong?</a></li>
</ul>
</li>
<li><a class="reference internal" href="#step-2-validate-the-deployment">Step 2: Validate the deployment</a><ul>
<li><a class="reference internal" href="#what-happens">What happens</a></li>
<li><a class="reference internal" href="#what-could-go-wrong">What could go wrong?</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#stage-4-deploy-to-production">Stage 4: Deploy to production</a><ul>
<li><a class="reference internal" href="#what-happens">What happens</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
   <div class='prev-next-top'>
     
      <a class='left-prev' href="how.html" title="previous chapter">Previous</a>
      <a class='right-next' href="../common_problems.html" title="next chapter">Next</a>
   <div style='clear:both;'></div>
 
   </div>


          <div class="body" role="main">
            
  <div class="section" id="what-does-a-mybinder-org-deployment-do">
<span id="what-does-a-mybinder-org-deployment-do"></span><h1>What does a MyBinder.org deployment do?<a class="headerlink" href="#what-does-a-mybinder-org-deployment-do" title="Permalink to this headline">¶</a></h1>
<p>This document tries to explain <em>what</em> is going on when a deployment
to mybinder.org happens. For <em>how</em> to do a deploy, please see <a class="reference external" href="deployment/how.html">how</a>.</p>
<p>The deployment happens in various <strong>stages</strong>, each of which comprise of
a series of <strong>steps</strong>. Each step of the deployment is
controlled by <code class="docutils literal notranslate"><span class="pre">.travis.yml</span></code>, which should be considered the authoritative
source of truth for deployment. <em>If this document disagrees with it,<code class="docutils literal notranslate"><span class="pre">.travis.yml</span></code> is correct!</em></p>
<p>If any of the steps in any stage fails, all following steps
are canceled and the deployment is marked as failed.</p>
<div class="section" id="stage-1-installing-deployment-tools">
<span id="stage-1-installing-deployment-tools"></span><h2>Stage 1: Installing deployment tools<a class="headerlink" href="#stage-1-installing-deployment-tools" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-1-install-all-the-things">
<span id="step-1-install-all-the-things"></span><h3>Step 1: Install all the things!<a class="headerlink" href="#step-1-install-all-the-things" title="Permalink to this headline">¶</a></h3>
<div class="section" id="background">
<span id="background"></span><h4>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h4>
<p>Deployment requires the following tools to be installed. Note:
since deployments are handled with <em>Travis CI</em>, you don’t
need them on your local computer.</p>
<ol>
<li><p><a class="reference external" href="https://cloud.google.com/sdk/"><code class="docutils literal notranslate"><span class="pre">gcloud</span></code></a></p>
<p>mybinder.org currently runs on <a class="reference external" href="https://cloud.google.com">Google Cloud</a>
in a <a class="reference external" href="https://cloud.google.com/kubernetes-engine/">Google Kubernetes Engine</a>
cluster. We need <code class="docutils literal notranslate"><span class="pre">gcloud</span></code> to authenticate ourselves to this cluster.</p>
</li>
<li><p><a class="reference external" href="https://helm.sh"><code class="docutils literal notranslate"><span class="pre">helm</span></code></a></p>
<p><code class="docutils literal notranslate"><span class="pre">helm</span></code> is the package manager for Kubernetes. We use this for actually installing
and upgrading the various components running mybinder.org (BinderHub, JupyterHub,
extra mybinder.org-specific services, etc)</p>
</li>
<li><p><a class="reference external" href="https://kubernetes.io/docs/reference/kubectl/overview/"><code class="docutils literal notranslate"><span class="pre">kubectl</span></code></a></p>
<p><code class="docutils literal notranslate"><span class="pre">kubectl</span></code> is the canonical command line client for interacting with the Kubernetes
API. We primarily use it to explicitly wait for our deployment to complete
before running our tests.</p>
</li>
<li><p><a class="reference external" href="https://docs.pytest.org"><code class="docutils literal notranslate"><span class="pre">pytest</span></code></a></p>
<p>We use <code class="docutils literal notranslate"><span class="pre">pytest</span></code> to verify that our deployment successfully completed, by running
a series of end-to-end tests (present in the <code class="docutils literal notranslate"><span class="pre">tests/</span></code> directory) against the
new deployment. This makes sure that both builds and launches are working,
and is an important part of giving us confidence to do continuous deployment.</p>
</li>
<li><p><a class="reference external" href="https://github.com/AGWA/git-crypt"><code class="docutils literal notranslate"><span class="pre">git-crypt</span></code></a></p>
<p>We have a bunch of secrets (in <code class="docutils literal notranslate"><span class="pre">secrets/</span></code>) in our deployment - things like
cloud credentials, etc. We use <code class="docutils literal notranslate"><span class="pre">git-crypt</span></code> to keep them in this repository
in an encrypted form. We use the <a class="reference external" href="https://docs.travis-ci.com/user/encrypting-files/">encrypted travis file</a>
for our repository to store the <code class="docutils literal notranslate"><span class="pre">git-crypt</span></code> decryption key.</p>
</li>
</ol>
</div>
<div class="section" id="what-happens">
<span id="what-happens"></span><h4>What happens<a class="headerlink" href="#what-happens" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>All of the tools above are installed. We use the <code class="docutils literal notranslate"><span class="pre">before_deploy</span></code> section
in <code class="docutils literal notranslate"><span class="pre">.travis.yml</span></code> to install these, mostly so we get nice log folding. The only exception
is the <code class="docutils literal notranslate"><span class="pre">pytest</span></code> installation - that is in the <code class="docutils literal notranslate"><span class="pre">install</span></code> section, so we can leverage
<a class="reference external" href="https://docs.travis-ci.com/user/caching/">travis caching</a> to speed up our deploys.</p></li>
</ul>
</div>
<div class="section" id="what-could-go-wrong">
<span id="what-could-go-wrong"></span><h4>What could go wrong?<a class="headerlink" href="#what-could-go-wrong" title="Permalink to this headline">¶</a></h4>
<p>All <strong>Stage 1</strong> failures can be attributed to one of the following causes:</p>
<ol>
<li><p>Network connections from Travis are being flaky, leading to failed installations</p>
<p>This is the most likely cause of Stage 1 failures. When this happens, we have no choice
but to restart the Travis Build.</p>
<p>If a restart also fails, there are two possible reasons:</p>
<ol class="simple">
<li><p>Travis is having some infrastructure issues. Check the <a class="reference external" href="https://www.traviscistatus.com/">Travis Status Page</a>
to see if this is the case.</p></li>
<li><p>The method we are using to install any of these bits of software is
having issues - either it no longer works due to some changes to the software, or
the software installer is depending on things that are having temporary difficulties.
Look at which software installation is failing, and debug that!</p></li>
</ol>
</li>
<li><p>The commit we are trying to deploy modified <code class="docutils literal notranslate"><span class="pre">.travis.yml</span></code>, and introduced a bug / typo.</p>
<p>The person who wrote the PR modifying <code class="docutils literal notranslate"><span class="pre">.travis.yml</span></code> should debug what
the error is and fix it in a subsequent PR.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="stage-2-configuring-deployment-tools">
<span id="stage-2-configuring-deployment-tools"></span><h2>Stage 2: Configuring deployment tools<a class="headerlink" href="#stage-2-configuring-deployment-tools" title="Permalink to this headline">¶</a></h2>
<div class="section" id="step-1-decrypting-secrets">
<span id="step-1-decrypting-secrets"></span><h3>Step 1: Decrypting secrets<a class="headerlink" href="#step-1-decrypting-secrets" title="Permalink to this headline">¶</a></h3>
<div class="section" id="background">
<span id="id1"></span><h4>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h4>
<p>The following secrets are present in encrypted form in the repository:</p>
<ol class="simple">
<li><p>Secret config for the helm charts (under <code class="docutils literal notranslate"><span class="pre">secrets/config</span></code>). These contain various
deployment secrets for staging and prod, such as proxy tokens, registry authentication,
etc.</p></li>
<li><p><a class="reference external" href="https://cloud.google.com/compute/docs/access/service-accounts">Google Cloud Service Accounts</a>
for both the staging and production Google cloud projects
(as <code class="docutils literal notranslate"><span class="pre">secrets/gke-auth-key-staging.json</span></code> and <code class="docutils literal notranslate"><span class="pre">secrets/gke-auth-key-prod.json</span></code>).
These have a <a class="reference external" href="https://cloud.google.com/iam/docs/understanding-roles">custom Role</a>
called <code class="docutils literal notranslate"><span class="pre">travis-deployer</span></code> that gives them <em>just</em> the permissions needed to do
deployments.</p></li>
<li><p>A <a class="reference external" href="https://developer.github.com/v3/guides/managing-deploy-keys/">GitHub deploy key</a>
for the <a class="reference external" href="https://github.com/binderhub-ci-repos/requirements">binderhub-ci-repos/requirements</a>
repo (as <code class="docutils literal notranslate"><span class="pre">secrets/binderhub-ci-key</span></code>). This is used in our tests to force the
deployed binderhub to do a build + launch, rather than just a launch (via
<code class="docutils literal notranslate"><span class="pre">tests/test_build.py</span></code>)</p></li>
</ol>
<p>The <code class="docutils literal notranslate"><span class="pre">git-crypt</span></code> symmetric key needed to decrypt these secrets is <code class="docutils literal notranslate"><span class="pre">travis/crypt-key.enc</span></code>,
encrypted with Travis’s <a class="reference external" href="https://docs.travis-ci.com/user/encrypting-files/">encrypted file</a>
support. Travis only supports one encrypted file per repo, and these are one-way encrypted
only (you can not get plain text back easily!), forcing us to use <code class="docutils literal notranslate"><span class="pre">git-crypt</span></code>.</p>
</div>
<div class="section" id="what-happens">
<span id="id2"></span><h4>What happens?<a class="headerlink" href="#what-happens" title="Permalink to this headline">¶</a></h4>
<ol class="simple">
<li><p>Decrypt the <code class="docutils literal notranslate"><span class="pre">git-crypt</span></code> key with the travis-provided <code class="docutils literal notranslate"><span class="pre">openssl</span></code> command</p></li>
<li><p>Decrypt all other secrets with the <code class="docutils literal notranslate"><span class="pre">git-crypt</span></code> key</p></li>
</ol>
<p>At the end of this step, all the secrets required for a successful deployment
are available in unencrypted form.</p>
</div>
<div class="section" id="what-could-go-wrong">
<span id="id3"></span><h4>What could go wrong?<a class="headerlink" href="#what-could-go-wrong" title="Permalink to this headline">¶</a></h4>
<ol>
<li><p>Someone has used the <code class="docutils literal notranslate"><span class="pre">travis</span> <span class="pre">encrypt-file</span></code> command for this repository, overwriting
the current travis encryption key (which is used to decrypt the <code class="docutils literal notranslate"><span class="pre">git-crypt</span></code> encryption
key), and committed this change. This causes issues because <code class="docutils literal notranslate"><span class="pre">travis</span> <span class="pre">encrypt-file</span></code>
can only encrypt one file per repo, so if you encrypt another file the first file
becomes undecryptable.</p>
<p>This will manifest as an error from the <code class="docutils literal notranslate"><span class="pre">openssl</span></code> command.</p>
<p>The simplest fix is to revert the PR that encrypted another file. <code class="docutils literal notranslate"><span class="pre">git-crypt</span></code>
should be used instead for encrypting additional files.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="step-2-setting-up-helm">
<span id="step-2-setting-up-helm"></span><h3>Step 2: Setting up Helm<a class="headerlink" href="#step-2-setting-up-helm" title="Permalink to this headline">¶</a></h3>
<div class="section" id="background">
<span id="id4"></span><h4>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h4>
<p>We use <a class="reference external" href="https://github.com/kubernetes/helm/blob/master/docs/charts.md">helm charts</a>
to configure mybinder.org. We use charts both from the
<a class="reference external" href="https://github.com/kubernetes/charts">official kubernetes charts repository</a>,
as well as the <a class="reference external" href="https://jupyterhub.github.io/helm-chart">JupyterHub charts repository</a>.</p>
</div>
<div class="section" id="what-happens">
<span id="id5"></span><h4>What happens<a class="headerlink" href="#what-happens" title="Permalink to this headline">¶</a></h4>
<p>To set up helm to do the deployment, we do the following:</p>
<ol class="simple">
<li><p>Set up the helm client, allowing it to create the local config files it needs
to function.</p></li>
<li><p>Set up the JupyterHub charts repository for use with this helm installation,
and fetch the latest chart definitions.</p></li>
<li><p>Fetch all the dependencies of the <code class="docutils literal notranslate"><span class="pre">mybinder</span></code> deployment chart with the versions
specified in <code class="docutils literal notranslate"><span class="pre">mybinder/requirements.yaml</span></code>, and store them locally to ready them
for deployment.</p></li>
</ol>
<p>At the end of this step, <code class="docutils literal notranslate"><span class="pre">helm</span></code> has been fully configured to do deployment of our
charts.</p>
</div>
<div class="section" id="what-could-go-wrong">
<span id="id6"></span><h4>What could go wrong?<a class="headerlink" href="#what-could-go-wrong" title="Permalink to this headline">¶</a></h4>
<ol>
<li><p>Invalid version for a dependency in <code class="docutils literal notranslate"><span class="pre">mybinder/requirements.yaml</span></code></p>
<p>This manifests as an error from <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">dep</span> <span class="pre">up</span></code> that looks like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Error</span><span class="p">:</span> <span class="n">Can</span><span class="s1">&#39;t get a valid version for repositories &lt;dependency&gt;. Try changing the version constraint in requirements.yaml</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&lt;dependency&gt;</span></code> in the above error message should point to the erroring dependency
whose version needs to be fixed.</p>
<p>If this happens for the <strong>binderhub</strong> dependency, the most common reason is that
you have not waited long enough after merging a PR in the binderhub repo before
bumping the version here. Make sure the version of binderhub is visible in
https://jupyterhub.github.io/helm-chart before merging a PR here.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="step-3-tell-grafana-our-deployment-is-starting">
<span id="step-3-tell-grafana-our-deployment-is-starting"></span><h3>Step 3: Tell Grafana our deployment is starting<a class="headerlink" href="#step-3-tell-grafana-our-deployment-is-starting" title="Permalink to this headline">¶</a></h3>
<p>We create an <a class="reference external" href="http://docs.grafana.org/reference/annotations/">annotation</a>
in Grafana, recording the fact that a deployment is starting.</p>
<p>This is very useful when looking at dashboards, since you can see
the effects of deployments in various metrics.</p>
</div>
</div>
<div class="section" id="stage-3-deploy-to-staging">
<span id="stage-3-deploy-to-staging"></span><h2>Stage 3: Deploy to staging<a class="headerlink" href="#stage-3-deploy-to-staging" title="Permalink to this headline">¶</a></h2>
<p>We have a <a class="reference external" href="https://staging.mybinder.org">staging environment</a> that is configured
exactly like production, but smaller (to control costs). We use this to test all
deployments before they hit the production mybinder.org website.</p>
<div class="section" id="step-1-set-up-and-do-the-helm-upgrade">
<span id="step-1-set-up-and-do-the-helm-upgrade"></span><h3>Step 1: Set up and do the helm upgrade<a class="headerlink" href="#step-1-set-up-and-do-the-helm-upgrade" title="Permalink to this headline">¶</a></h3>
<div class="section" id="what-happens">
<span id="id7"></span><h4>What happens<a class="headerlink" href="#what-happens" title="Permalink to this headline">¶</a></h4>
<p>We use the <code class="docutils literal notranslate"><span class="pre">deploy.py</span></code> script to do the helm deployment. This script does the
following:</p>
<ol class="simple">
<li><p>Use the Google Cloud Service Accounts we decrypted in Stage 2, Step 1 to get
a valid <a class="reference external" href="https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/">~/.kube/config</a>
file. This file is used by both <code class="docutils literal notranslate"><span class="pre">helm</span></code> and <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> to access the cluster.</p></li>
<li><p>Use <a class="reference external" href="https://github.com/kubernetes/helm/blob/master/docs/helm/helm_upgrade.md"><code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">upgrade</span></code></a>
to actually do the deployment. This deploys whatever changes the commit has -
new chart versions, changes to configuration, new repo2docker version, etc.
We have a ten minute timeout here.</p></li>
<li><p>We use <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">rollout</span></code> to wait for all <a class="reference external" href="https://kubernetes.io/docs/concepts/workloads/controllers/deployment/">Deployment</a>
and <a class="reference external" href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">DaemonSet</a>
objects to be fully ready. Theoretically the <code class="docutils literal notranslate"><span class="pre">--wait</span></code> param to <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">upgrade</span></code> does
this - but it is not complete enough for our use case.</p></li>
</ol>
<p>Once we have verified that all the <code class="docutils literal notranslate"><span class="pre">Deployment</span></code> and <code class="docutils literal notranslate"><span class="pre">DaemonSet</span></code> objects are ready,
the helm deployment is complete!</p>
</div>
<div class="section" id="what-could-go-wrong">
<span id="id8"></span><h4>What could go wrong?<a class="headerlink" href="#what-could-go-wrong" title="Permalink to this headline">¶</a></h4>
<ol>
<li><p>YAML formatting issue in one of the config files</p>
<p>YAML syntax can be finnicky sometimes, and fail in non-obvious ways. The most common
error is the presence of tab characters in YAML, which will make them always fail.</p>
<p>The Helm community has <a class="reference external" href="https://github.com/kubernetes/helm/blob/master/docs/chart_template_guide/yaml_techniques.md">some tips</a>
on common YAML issues. Learn X in Y Minutes also has a nice <a class="reference external" href="https://learnxinyminutes.com/docs/yaml/">guide on YAML</a>.
You can also use <a class="reference external" href="https://github.com/adrienverge/yamllint">yamllint</a> locally to validate
your YAML files.</p>
<p>Remember to <strong>not</strong> copy paste any secret files into online YAML Linting applications
for linting! That could possibly compromise mybinder.org.</p>
</li>
<li><p>Kubernetes cluster is having difficulties</p>
<p>This is usually manifested by either <code class="docutils literal notranslate"><span class="pre">helm</span></code> or <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> reporting connection errors.</p>
</li>
<li><p>Bugs in helm itself</p>
<p>Fairly rare, but bugs in helm itself might cause failure.</p>
</li>
<li><p>Severe bugs in the version of binderhub, jupyterhub or any of the dependencies deployed.</p>
<p>This will usually manifest as a <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">rollout</span></code> command hanging forever. This is
caused by a bug in the component that <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">rollout</span></code> is waiting for constantly
crashing, unable to stay up.</p>
<p>Looking at what component it is, and perhaps in the logs, would help!</p>
</li>
</ol>
</div>
</div>
<div class="section" id="step-2-validate-the-deployment">
<span id="step-2-validate-the-deployment"></span><h3>Step 2: Validate the deployment<a class="headerlink" href="#step-2-validate-the-deployment" title="Permalink to this headline">¶</a></h3>
<div class="section" id="what-happens">
<span id="id9"></span><h4>What happens<a class="headerlink" href="#what-happens" title="Permalink to this headline">¶</a></h4>
<p>We run the tests in <code class="docutils literal notranslate"><span class="pre">tests/</span></code> with <code class="docutils literal notranslate"><span class="pre">pytest</span></code> to validate that the deployment succeeded.
These try to be as thorough as possible, simulating the tests a human would do to
ensure that the site works as required.</p>
<p>Look at the docstrings in the files under <a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/tree/master/tests"><code class="docutils literal notranslate"><span class="pre">tests/</span></code></a>
to see what are the tests being run.</p>
<p>If all the tests succeed, we can consider the staging deployment success!</p>
</div>
<div class="section" id="what-could-go-wrong">
<span id="id10"></span><h4>What could go wrong?<a class="headerlink" href="#what-could-go-wrong" title="Permalink to this headline">¶</a></h4>
<ol>
<li><p>Bugs in the version of binderhub or jupyterhub deployed, causing any of the tests
in <code class="docutils literal notranslate"><span class="pre">tests/</span></code> to fail.</p>
<p>The output should tell you which test fails. You can look at the docstring for the
failing test to understand what it is was testing, and debug from there.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="stage-4-deploy-to-production">
<span id="stage-4-deploy-to-production"></span><h2>Stage 4: Deploy to production<a class="headerlink" href="#stage-4-deploy-to-production" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-happens">
<span id="id11"></span><h3>What happens<a class="headerlink" href="#what-happens" title="Permalink to this headline">¶</a></h3>
<p>After deploying to <code class="docutils literal notranslate"><span class="pre">staging</span></code> and validating it with tests, we have a reasonable amount of confidence
that it is safe to deploy to production. Production deploy has the exact same steps as
<code class="docutils literal notranslate"><span class="pre">staging</span></code>, but targets production (branch and namespace <code class="docutils literal notranslate"><span class="pre">prod</span></code>) instead of staging.</p>
</div>
</div>
</div>


          </div>
   <div class='prev-next-bottom'>
     
      <a class='left-prev' href="how.html" title="previous chapter">How to deploy a change to mybinder.org?</a>
      <a class='right-next' href="../common_problems.html" title="next chapter">Common problems and their solutions</a>
   <div style='clear:both;'></div>
 
   </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <p class="logo"><a href="../index.html">
    <img class="logo" src="../_static/logo.jpg" alt="Logo"/>
  </a></p>
<h1 class="logo"><a href="../index.html">Site Reliability Guide for mybinder.org</a></h1>



<p class="blurb">A Site Reliability Guide for mybinder.org deployment</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jupyterhub&repo=binderhub&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<h3>Table of Contents</h3>
<p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with the <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code> dev team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../production_environment.html">Production environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminology.html">Terminology for the deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="prereqs.html">Pre-requisite technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="how.html">How to deploy a change to mybinder.org?</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">What does a MyBinder.org deployment do?</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#stage-1-installing-deployment-tools">Stage 1: Installing deployment tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stage-2-configuring-deployment-tools">Stage 2: Configuring deployment tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stage-3-deploy-to-staging">Stage 3: Deploy to staging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#stage-4-deploy-to-production">Stage 4: Deploy to production</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Operation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../common_problems.html">Common problems and their solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_snippets.html">Command snippets used during operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grafana_plots.html">Some useful Grafana plots</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/metrics.html">Metrics collection with Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/dashboards.html">Operational Dashboards with Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/ingress.html">HTTPS ingress with nginx + kube-lego</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/cloud.html">Cloud products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/matomo.html">Matomo (formerly Piwik) analytics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../analytics/events-archive.html">The Analytics Events Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analytics/cloud-costs.html">Cloud Costs Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Incidents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2019-04-03-ingress-cordoned.html">2019-04-03, 30min outage during node pool upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2019-03-24-r2d-upgrade.html">2019-03-24, repo2docker upgrade and docker image cache wipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2019-02-20-no-logs.html">incident date: 2019-02-20, kubectl logs unavailable</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-07-30-jupyterlab-build-cpu-saturate.html">2018-07-30 JupyterLab builds saturate BinderHub CPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-07-08-podsnips-aplenty.html">2018-07-08, too many pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-04-18-cull-flood.html">2018-04-18, Culler flood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-03-31-server-start-fail.html">2018-03-31, Server launch failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-03-26-no-space-left.html">2018-03-26, “no space left on device”</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-03-13-PVC-hub-locked.html">2018-03-13, PVC for hub is locked</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-02-22-nginx-down.html">2018-02-22 NGINX crash</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-02-20-jupyterlab-announcement.html">2018-02-20, JupyterLab Announcement swamps Binder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-02-12-launch-fail.html">2018-02-12, Hub Launch Fail</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-01-18-reddit-hug.html">2018-01-18, reddit hugs mybinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-01-18-ssl-outdated.html">2018-01-11, Warning from letsencrypt about outdated SSL certificate</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-01-17-ubuntu-upgrade.html">2018-01-17, Emergency Aardvark bump</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2018-01-04-failed-staging-deploy.html">2018-01-04, Failed deploy to staging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2017-11-30-oom-proxy.html">2017-11-30 4:23PM PST, OOM (Out of Memory) Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2017-10-17-cluster-full.html">2017-10-17, Cluster Full</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2017-09-29-504.html">2017-09-29, 504</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/2017-09-27-hub-403.html">2017-09-27, Hub 403</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/template-incident-report.html">Template for reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="../incident-reports/template-incident-report.html#incident-date-yyyy-mm-dd-incident-name">{{ incident date: yyyy-mm-dd }}, {{ incident name }}</a></li>
</ul>


<div class="relations">
<h3>Navigation</h3>
<ul>
  <li><a href="../index.html">Documentation Home</a><ul>
  <li><a href="how.html" title="Previous">Previous topic</a></li>
  <li><a href="../common_problems.html" title="Next">Next topic</a></li>
  </ul>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/deployment/what.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
        <form class="search" action="../search.html" method="get">
            <input type="text" name="q" placeholder="Quick Search" aria-labelledby="searchlabel" />
            <input type="submit" value="Go" />
        </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017 - 2019, Binder Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/deployment/what.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>