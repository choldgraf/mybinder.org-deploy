
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>2018-07-08, too many pods &#8212; Site Reliability Guide for mybinder.org 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2018-04-18, Culler flood" href="2018-04-18-cull-flood.html" />
    <link rel="prev" title="2018-07-30 JupyterLab builds saturate BinderHub CPU" href="2018-07-30-jupyterlab-build-cpu-saturate.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<!-- Add JupyterHub styling -->
<link rel="stylesheet" href="../_static/jupyter.css" type="text/css" />
<link rel="shortcut icon" href="../_static/favicon.ico"/>


  </head><body>
<div class="rightsidebar">
    <h3>On this page</h3>
    <ul>
<li><a class="reference internal" href="#">2018-07-08, too many pods</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#timeline">Timeline</a><ul>
<li><a class="reference internal" href="#ca-18-30">2018-07-08 ca. 18:30</a></li>
<li><a class="reference internal" href="#">22:48</a></li>
<li><a class="reference internal" href="#">23:25</a></li>
<li><a class="reference internal" href="#">2018-07-09 08:00</a></li>
<li><a class="reference internal" href="#">10:00</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lessons-learned">Lessons learned</a><ul>
<li><a class="reference internal" href="#what-went-well">What went well</a></li>
<li><a class="reference internal" href="#what-went-wrong">What went wrong</a></li>
</ul>
</li>
<li><a class="reference internal" href="#action-items">Action items</a><ul>
<li><a class="reference internal" href="#process-improvements">Process improvements</a></li>
<li><a class="reference internal" href="#documentation-improvements">Documentation improvements</a></li>
<li><a class="reference internal" href="#technical-improvements">Technical improvements</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
   <div class='prev-next-top'>
     
      <a class='left-prev' href="2018-07-30-jupyterlab-build-cpu-saturate.html" title="previous chapter">Previous</a>
      <a class='right-next' href="2018-04-18-cull-flood.html" title="next chapter">Next</a>
   <div style='clear:both;'></div>
 
   </div>


          <div class="body" role="main">
            
  <div class="section" id="too-many-pods">
<span id="too-many-pods"></span><h1>2018-07-08, too many pods<a class="headerlink" href="#too-many-pods" title="Permalink to this headline">¶</a></h1>
<div class="section" id="summary">
<span id="summary"></span><h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>Pod shutdown stopped functioning,
resulting in constant growth of pods,
eventually filling the cluster and new launches failing.
Total service disruption for Binder lasted for approximately five hours on a Saturday evening.</p>
</div>
<div class="section" id="timeline">
<span id="timeline"></span><h2>Timeline<a class="headerlink" href="#timeline" title="Permalink to this headline">¶</a></h2>
<p>All times in CEST (UTC+2)</p>
<div class="section" id="ca-18-30">
<span id="ca-18-30"></span><h3>2018-07-08 ca. 18:30<a class="headerlink" href="#ca-18-30" title="Permalink to this headline">¶</a></h3>
<p>Launch success drops to zero.</p>
</div>
<div class="section" id="">
<span id="id1"></span><h3>22:48<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Suspicious behavior reported on gitter.</p>
</div>
<div class="section" id="">
<span id="id2"></span><h3>23:25<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Investigation launched.
Cluster is full, scaled up to 8 nodes.
Almost 1k user pods are found (737 running, 240 waiting to be scheduled).
Pods older than 4 hours are deleted,
and some of the most-used images (such as ipython-in-depth)
are culled more aggressively.</p>
<p>After culling ~600 pods and restarting the Hub pod, launches are back to normal.</p>
<p>Some of the nodes allocated due to the flood of pods are cordoned to be reclaimed by the autoscaler.</p>
<p>Launches return to stable and European-timezone team retires for the night.</p>
</div>
<div class="section" id="">
<span id="id3"></span><h3>2018-07-09 08:00<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Manual max-age culling frees up some of the remaining nodes.
Cluster is able to scale back to 3 nodes.</p>
</div>
<div class="section" id="">
<span id="id4"></span><h3>10:00<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Investigating hub logs shows indications that the pod reflector has stopped receiving events ca 18:30 CEST, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>2018-07-07 18:32:27.000 CEST
TimeoutError: pod/jupyter-ipython-2dipython-2din-2ddepth-... did not disappear in 300 seconds!
2018-07-07 18:34:04.000 CEST
TimeoutError: pod/jupyter-bokeh-2dbokeh-2dnotebooks-... did not start in 300 seconds!
</pre></div>
</div>
<p>Shortly thereafter, pod deletion is skipped for pods that launch but are not in the pod reflector, presumably for the same reason they are skipped in the above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">07</span> <span class="mi">18</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">35.000</span> <span class="n">CEST</span>
<span class="p">[</span><span class="n">W</span> <span class="mi">2018</span><span class="o">-</span><span class="mi">07</span><span class="o">-</span><span class="mi">07</span> <span class="mi">16</span><span class="p">:</span><span class="mi">38</span><span class="p">:</span><span class="mf">35.506</span> <span class="n">JupyterHub</span> <span class="n">spawner</span><span class="p">:</span><span class="mi">1476</span><span class="p">]</span> <span class="n">No</span> <span class="n">pod</span> <span class="n">jupyter</span><span class="o">-</span><span class="n">ipython</span><span class="o">-</span><span class="mi">2</span><span class="n">dipython</span><span class="o">-</span><span class="mi">2</span><span class="n">din</span><span class="o">-</span><span class="mi">2</span><span class="n">ddepth</span><span class="o">-...</span> <span class="n">to</span> <span class="n">delete</span><span class="o">.</span> <span class="n">Assuming</span> <span class="n">already</span> <span class="n">deleted</span><span class="o">.</span>
</pre></div>
</div>
<p>These pods <em>have</em> started, but aren’t registered in the pod reflector,
so in aborting the launch, the pod is not deleted.
This is the direct cause of the runaway pod growth,
though the root cause is that the pod reflector has stopped updating.</p>
</div>
</div>
<div class="section" id="lessons-learned">
<span id="lessons-learned"></span><h2>Lessons learned<a class="headerlink" href="#lessons-learned" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-went-well">
<span id="what-went-well"></span><h3>What went well<a class="headerlink" href="#what-went-well" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>mybinder.org-deploy/scripts/delete-pods.py script was useful for bulk deleting older pods to get things back under control.</p></li>
<li><p>once noticed, cluster returned to healthy within a few minutes.</p></li>
</ul>
<p>List of things that went well. For example,</p>
<ol class="simple">
<li><p>We were alerted to the outage by automated bots before it affected users</p></li>
<li><p>The staging cluster helped us catch this before it went to prod</p></li>
</ol>
</div>
<div class="section" id="what-went-wrong">
<span id="what-went-wrong"></span><h3>What went wrong<a class="headerlink" href="#what-went-wrong" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>pod reflector in kubespawner stopped receiving events,
leading to total launch failure until the Hub was restarted.</p></li>
<li><p>A compounding bug caused pods that the reflector failed to notice starting
skipped deletion because they were assumed not to have been created in the first place.</p></li>
<li><p>outage lasted a long time (five hours) before we noticed. We still don’t have downtime notifications setup.</p></li>
<li><p>cluster scale-down still involves several manual steps of cordoning and draining nodes.</p></li>
</ul>
</div>
</div>
<div class="section" id="action-items">
<span id="action-items"></span><h2>Action items<a class="headerlink" href="#action-items" title="Permalink to this headline">¶</a></h2>
<p>These are only sample subheadings. Every action item should have a GitHub issue
(even a small skeleton of one) attached to it, so these do not get forgotten.</p>
<div class="section" id="process-improvements">
<span id="process-improvements"></span><h3>Process improvements<a class="headerlink" href="#process-improvements" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>set up notifications of downtime (<a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/611">issue</a>)</p></li>
<li><p>automate scale-down (<a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/646">issue</a>)</p></li>
</ol>
</div>
<div class="section" id="documentation-improvements">
<span id="documentation-improvements"></span><h3>Documentation improvements<a class="headerlink" href="#documentation-improvements" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>make sure downtime recovery steps are documented.
They worked well this time,
but not all team members may know the steps.
(<a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/655">issue</a>)</p></li>
</ol>
</div>
<div class="section" id="technical-improvements">
<span id="technical-improvements"></span><h3>Technical improvements<a class="headerlink" href="#technical-improvements" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Fix failure to delete pods when pod reflector fails
(<a class="reference external" href="https://github.com/jupyterhub/kubespawner/pull/208">pull request</a>)</p></li>
<li><p>Make kubespawner more robust to pod-reflector failure
(<a class="reference external" href="https://github.com/jupyterhub/kubespawner/issues/209">issue</a>)</p></li>
<li><p>Refactor event reflector to be a single reflector instead of one-per-pod.
The new event reflectors were one major new feature in KubeSpawner,
and may have been relevant to the failure (not clear yet)
(<a class="reference external" href="https://github.com/jupyterhub/kubespawner/issues/210">issue</a>).</p></li>
<li><p>try to auto-detect likely unhealthy Hub state and restart the Hub without manual intervention (<a class="reference external" href="https://github.com/jupyterhub/jupyterhub/issues/2028">issue</a>)</p></li>
</ol>
</div>
</div>
</div>


          </div>
   <div class='prev-next-bottom'>
     
      <a class='left-prev' href="2018-07-30-jupyterlab-build-cpu-saturate.html" title="previous chapter">2018-07-30 JupyterLab builds saturate BinderHub CPU</a>
      <a class='right-next' href="2018-04-18-cull-flood.html" title="next chapter">2018-04-18, Culler flood</a>
   <div style='clear:both;'></div>
 
   </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <p class="logo"><a href="../index.html">
    <img class="logo" src="../_static/logo.jpg" alt="Logo"/>
  </a></p>
<h1 class="logo"><a href="../index.html">Site Reliability Guide for mybinder.org</a></h1>



<p class="blurb">A Site Reliability Guide for mybinder.org deployment</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jupyterhub&repo=binderhub&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<h3>Table of Contents</h3>
<p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with the <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code> dev team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../production_environment.html">Production environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminology.html">Terminology for the deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deployment/prereqs.html">Pre-requisite technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/how.html">How to deploy a change to mybinder.org?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/what.html">What does a MyBinder.org deployment do?</a></li>
</ul>
<p class="caption"><span class="caption-text">Operation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../common_problems.html">Common problems and their solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_snippets.html">Command snippets used during operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grafana_plots.html">Some useful Grafana plots</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/metrics.html">Metrics collection with Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/dashboards.html">Operational Dashboards with Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/ingress.html">HTTPS ingress with nginx + kube-lego</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/cloud.html">Cloud products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/matomo.html">Matomo (formerly Piwik) analytics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../analytics/events-archive.html">The Analytics Events Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analytics/cloud-costs.html">Cloud Costs Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Incidents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="2019-04-03-ingress-cordoned.html">2019-04-03, 30min outage during node pool upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="2019-03-24-r2d-upgrade.html">2019-03-24, repo2docker upgrade and docker image cache wipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="2019-02-20-no-logs.html">incident date: 2019-02-20, kubectl logs unavailable</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-07-30-jupyterlab-build-cpu-saturate.html">2018-07-30 JupyterLab builds saturate BinderHub CPU</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2018-07-08, too many pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-04-18-cull-flood.html">2018-04-18, Culler flood</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-31-server-start-fail.html">2018-03-31, Server launch failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-26-no-space-left.html">2018-03-26, “no space left on device”</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-13-PVC-hub-locked.html">2018-03-13, PVC for hub is locked</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-22-nginx-down.html">2018-02-22 NGINX crash</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-20-jupyterlab-announcement.html">2018-02-20, JupyterLab Announcement swamps Binder</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-12-launch-fail.html">2018-02-12, Hub Launch Fail</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-18-reddit-hug.html">2018-01-18, reddit hugs mybinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-18-ssl-outdated.html">2018-01-11, Warning from letsencrypt about outdated SSL certificate</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-17-ubuntu-upgrade.html">2018-01-17, Emergency Aardvark bump</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-04-failed-staging-deploy.html">2018-01-04, Failed deploy to staging</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-11-30-oom-proxy.html">2017-11-30 4:23PM PST, OOM (Out of Memory) Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-10-17-cluster-full.html">2017-10-17, Cluster Full</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-09-29-504.html">2017-09-29, 504</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-09-27-hub-403.html">2017-09-27, Hub 403</a></li>
<li class="toctree-l1"><a class="reference internal" href="template-incident-report.html">Template for reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="template-incident-report.html#incident-date-yyyy-mm-dd-incident-name">{{ incident date: yyyy-mm-dd }}, {{ incident name }}</a></li>
</ul>


<div class="relations">
<h3>Navigation</h3>
<ul>
  <li><a href="../index.html">Documentation Home</a><ul>
  <li><a href="2018-07-30-jupyterlab-build-cpu-saturate.html" title="Previous">Previous topic</a></li>
  <li><a href="2018-04-18-cull-flood.html" title="Next">Next topic</a></li>
  </ul>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/incident-reports/2018-07-08-podsnips-aplenty.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
        <form class="search" action="../search.html" method="get">
            <input type="text" name="q" placeholder="Quick Search" aria-labelledby="searchlabel" />
            <input type="submit" value="Go" />
        </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017 - 2019, Binder Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/incident-reports/2018-07-08-podsnips-aplenty.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>