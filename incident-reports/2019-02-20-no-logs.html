
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>incident date: 2019-02-20, kubectl logs unavailable &#8212; Site Reliability Guide for mybinder.org 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="2018-07-30 JupyterLab builds saturate BinderHub CPU" href="2018-07-30-jupyterlab-build-cpu-saturate.html" />
    <link rel="prev" title="2019-03-24, repo2docker upgrade and docker image cache wipe" href="2019-03-24-r2d-upgrade.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<!-- Add JupyterHub styling -->
<link rel="stylesheet" href="../_static/jupyter.css" type="text/css" />
<link rel="shortcut icon" href="../_static/favicon.ico"/>


  </head><body>
<div class="rightsidebar">
    <h3>On this page</h3>
    <ul>
<li><a class="reference internal" href="#">incident date: 2019-02-20, kubectl logs unavailable</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#timeline">Timeline</a><ul>
<li><a class="reference internal" href="#">2019-02-20 08:03</a></li>
<li><a class="reference internal" href="#">2019-02-20 10:12</a></li>
<li><a class="reference internal" href="#">2019-02-20 10:20</a></li>
<li><a class="reference internal" href="#">2019-02-20 11:17</a></li>
<li><a class="reference internal" href="#">12:00</a></li>
<li><a class="reference internal" href="#">13:30</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lessons-learnt">Lessons learnt</a><ul>
<li><a class="reference internal" href="#what-went-well">What went well</a></li>
<li><a class="reference internal" href="#what-went-wrong">What went wrong</a></li>
<li><a class="reference internal" href="#where-we-got-lucky">Where we got lucky</a></li>
</ul>
</li>
<li><a class="reference internal" href="#action-items">Action items</a><ul>
<li><a class="reference internal" href="#process-improvements">Process improvements</a></li>
<li><a class="reference internal" href="#documentation-improvements">Documentation improvements</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
   <div class='prev-next-top'>
     
      <a class='left-prev' href="2019-03-24-r2d-upgrade.html" title="previous chapter">Previous</a>
      <a class='right-next' href="2018-07-30-jupyterlab-build-cpu-saturate.html" title="next chapter">Next</a>
   <div style='clear:both;'></div>
 
   </div>


          <div class="body" role="main">
            
  <div class="section" id="incident-date-2019-02-20-kubectl-logs-unavailable">
<span id="incident-date-2019-02-20-kubectl-logs-unavailable"></span><h1>incident date: 2019-02-20, kubectl logs unavailable<a class="headerlink" href="#incident-date-2019-02-20-kubectl-logs-unavailable" title="Permalink to this headline">¶</a></h1>
<div class="section" id="summary">
<span id="summary"></span><h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>For new builds users did not see the build logs. Builds did happen normally though. Fixed by removing node that had no IP address in its metadata.</p>
</div>
<div class="section" id="timeline">
<span id="timeline"></span><h2>Timeline<a class="headerlink" href="#timeline" title="Permalink to this headline">¶</a></h2>
<p>All times in Central European Time (CET)</p>
<div class="section" id="">
<span id="id1"></span><h3>2019-02-20 08:03<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span> <span class="pre">-f</span> <span class="pre">&lt;pod&gt;</span></code> has stopped working, reporting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Error from server: Get https://10.128.0.6:10250/containerLogs/prod/jupyter-.../notebook?follow=true: No SSH tunnels currently open. Were the targets able to accept an ssh-key for user &quot;gke-df315ed616f010764e03&quot;?
</pre></div>
</div>
<p>This occurs for all pods.
Failure to retrieve pod logs means that build logs are not being forwarded to users.</p>
<p>This occurred once previously on 2019-01-08 and lasted 24 hours.
The first occurrence resolved itself without ever being diagnosed.</p>
</div>
<div class="section" id="">
<span id="id2"></span><h3>2019-02-20 10:12<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Deploy of a minor bump fails due to the failure to create ssh tunnels.</p>
</div>
<div class="section" id="">
<span id="id3"></span><h3>2019-02-20 10:20<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Planned upgrade of cluster begins,
hoping that upgrading master and bringing in new nodes will fix the issue.</p>
</div>
<div class="section" id="">
<span id="id4"></span><h3>2019-02-20 11:17<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>New nodes are fully up and running (old nodes are still present and draining),
and <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span></code> still fails with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Error from server: Get https://10.128.0.17:10250/...?follow=true: No SSH tunnels currently open. Were the targets able to accept an ssh-key for user &quot;gke-df315ed616f010764e03&quot;?
</pre></div>
</div>
<p>At this point, we know that upgrading master and the nodes will <em>not</em> fix <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span></code>,
at least for new nodes.
We do not yet know whether removing old nodes will fix the issue (<em>spoiler: it will</em>).
Investigation begins in earnest.</p>
<p><a class="reference external" href="https://cloud.google.com/kubernetes-engine/docs/troubleshooting#kubect_commands_hang">Troubleshooting documentation</a>
suggests that something could have gone wrong with the master’s ssh access to the nodes.</p>
<p>This is verified not to be the case by checking:</p>
<ol class="simple">
<li><p>ssh-key metadata is not too full</p></li>
<li><p>ssh key for gke-df315ed616f010764e03 is present on all nodes in /home/gke-df315ed616f010764e03/.ssh/authorized_keys</p></li>
<li><p>firewall rules allow ssh from master, which is doubly verified by attempting to ssh to <code class="docutils literal notranslate"><span class="pre">gke-df315ed616f010764e03&#64;a.b.c.d</span></code> for a node from outside the cluster</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">df315</span></code> verifies that debugging attempts to ssh were rejected by public key and no such attempt was made from the master</p></li>
</ol>
<p>At this point we know that there is nothing on the nodes preventing the master from creating an ssh tunnel.
It must be something wrong on the master,
and worryingly is something wrong on the master that is not fixed by upgrading the master.</p>
</div>
<div class="section" id="">
<span id="id5"></span><h3>12:00<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>After some Googling, we found how to get the API server logs:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl proxy <span class="p">&amp;</span>
curl -O http://localhost:8001/logs/kube-apiserver.log
</pre></div>
</div>
<p>Searching the API server logs for clues relating to ssh:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grep</span> <span class="n">ssh</span> <span class="n">kube</span><span class="o">-</span><span class="n">apiserver</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>revealed only one hint: a repeated occurrence of</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">E0220</span> <span class="mi">10</span><span class="p">:</span><span class="mi">59</span><span class="p">:</span><span class="mf">57.797466</span>       <span class="mi">1</span> <span class="n">ssh</span><span class="o">.</span><span class="n">go</span><span class="p">:</span><span class="mi">200</span><span class="p">]</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">getAddresses</span><span class="p">:</span> <span class="n">no</span> <span class="n">preferred</span> <span class="n">addresses</span> <span class="n">found</span><span class="p">;</span> <span class="n">known</span> <span class="n">addresses</span><span class="p">:</span> <span class="p">[{</span><span class="n">Hostname</span> <span class="n">gke</span><span class="o">-</span><span class="n">prod</span><span class="o">-</span><span class="n">a</span><span class="o">-</span><span class="n">users</span><span class="o">-</span><span class="n">b921bb88</span><span class="o">-</span><span class="n">rd5d</span><span class="p">}]</span>
</pre></div>
</div>
<p>along with numerous repeats of the much less informative error:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">logging</span> <span class="n">error</span> <span class="n">output</span><span class="p">:</span> <span class="s2">&quot;Error: &#39;No SSH tunnels currently open. Were the targets able to accept an ssh-key for user </span><span class="se">\&quot;</span><span class="s2">gke-df315ed616f010764e03</span><span class="se">\&quot;</span><span class="s2">?</span>
</pre></div>
</div>
<p>This gives us hope that the issue may go away when the listed node <code class="docutils literal notranslate"><span class="pre">gke-prod-a-users-b921bb88-rd5d</span></code> is removed.
The node has been cordoned and will be removed from the pool when it is empty.</p>
</div>
<div class="section" id="">
<span id="id6"></span><h3>13:30<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>with rd5d drained and removed from the pool,
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span></code> is restored and everything is working.</p>
</div>
</div>
<div class="section" id="lessons-learnt">
<span id="lessons-learnt"></span><h2>Lessons learnt<a class="headerlink" href="#lessons-learnt" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-went-well">
<span id="what-went-well"></span><h3>What went well<a class="headerlink" href="#what-went-well" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Even throughout this process while <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span></code> didn’t work and upgrading the whole cluster,
launch success rate never dropped below 97.5%,
and only very briefly below 100%.
Great job!</p></li>
<li><p>Once the problematic node was removed, everything recovered.</p></li>
</ul>
</div>
<div class="section" id="what-went-wrong">
<span id="what-went-wrong"></span><h3>What went wrong<a class="headerlink" href="#what-went-wrong" title="Permalink to this headline">¶</a></h3>
<p>Things that could have gone better. Ideally these should result in concrete
action items that have GitHub issues created for them and linked to under
Action items. For example,</p>
<ul class="simple">
<li><p>It was very difficult to identify the root cause of the issue,
in part because it appears to be a bug in the kubernetes master and/or the GKE service itself.</p></li>
<li><p>It would have been useful to get a <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">describe</span> <span class="pre">node</span> <span class="pre">gke-prod-a-users-b921bb88-rd5d</span></code> once we were suspicious of the node,
to use as reference comparing the unhealthy node to healthy ones,
especially now that we know that this node was indeed the cause</p></li>
</ul>
</div>
<div class="section" id="where-we-got-lucky">
<span id="where-we-got-lucky"></span><h3>Where we got lucky<a class="headerlink" href="#where-we-got-lucky" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>While the event was occurring, the following command was run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>kubectl get node -o json <span class="p">|</span> jq <span class="s1">&#39;.items[] | [.status.addresses[].address]&#39;</span>
</pre></div>
</div>
<p>in order to retrieve ip addresses of nodes for testing direct ssh access.
The problematic node reported unusually having no known ExternalIP or InternalIP. A normal entry looks like:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="s2">&quot;10.128.xxx.yyy&quot;</span><span class="p">,</span>
  <span class="s2">&quot;35.202.xxx.yyy&quot;</span><span class="p">,</span>
  <span class="s2">&quot;gke-prod-a-user-be5bcf07-xhxd&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>while the unhealthy node reported</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
  <span class="s2">&quot;&quot;</span><span class="p">,</span>
  <span class="s2">&quot;gke-prod-a-users-b921bb88-rd5d&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
<p>indicating that kubernetes had lost track of the node’s ExternalIP and InternalIP.
This was likely a direct symptom of the problem and could be used as a diagnostic in the future.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="action-items">
<span id="action-items"></span><h2>Action items<a class="headerlink" href="#action-items" title="Permalink to this headline">¶</a></h2>
<div class="section" id="process-improvements">
<span id="process-improvements"></span><h3>Process improvements<a class="headerlink" href="#process-improvements" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>test and notify when <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span></code> doesn’t work <a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/900">issue</a></p></li>
</ol>
</div>
<div class="section" id="documentation-improvements">
<span id="documentation-improvements"></span><h3>Documentation improvements<a class="headerlink" href="#documentation-improvements" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>add command to retrieve apiserver logs to sre guide <a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/901">issue</a></p></li>
<li><p>describe how to identify suspicious networking status in sre guide <a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/900">issue</a></p></li>
</ol>
</div>
</div>
</div>


          </div>
   <div class='prev-next-bottom'>
     
      <a class='left-prev' href="2019-03-24-r2d-upgrade.html" title="previous chapter">2019-03-24, repo2docker upgrade and docker image cache wipe</a>
      <a class='right-next' href="2018-07-30-jupyterlab-build-cpu-saturate.html" title="next chapter">2018-07-30 JupyterLab builds saturate BinderHub CPU</a>
   <div style='clear:both;'></div>
 
   </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <p class="logo"><a href="../index.html">
    <img class="logo" src="../_static/logo.jpg" alt="Logo"/>
  </a></p>
<h1 class="logo"><a href="../index.html">Site Reliability Guide for mybinder.org</a></h1>



<p class="blurb">A Site Reliability Guide for mybinder.org deployment</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jupyterhub&repo=binderhub&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<h3>Table of Contents</h3>
<p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with the <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code> dev team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../production_environment.html">Production environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminology.html">Terminology for the deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deployment/prereqs.html">Pre-requisite technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/how.html">How to deploy a change to mybinder.org?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/what.html">What does a MyBinder.org deployment do?</a></li>
</ul>
<p class="caption"><span class="caption-text">Operation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../common_problems.html">Common problems and their solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_snippets.html">Command snippets used during operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grafana_plots.html">Some useful Grafana plots</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/metrics.html">Metrics collection with Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/dashboards.html">Operational Dashboards with Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/ingress.html">HTTPS ingress with nginx + kube-lego</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/cloud.html">Cloud products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/matomo.html">Matomo (formerly Piwik) analytics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../analytics/events-archive.html">The Analytics Events Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analytics/cloud-costs.html">Cloud Costs Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Incidents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="2019-04-03-ingress-cordoned.html">2019-04-03, 30min outage during node pool upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="2019-03-24-r2d-upgrade.html">2019-03-24, repo2docker upgrade and docker image cache wipe</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">incident date: 2019-02-20, kubectl logs unavailable</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-07-30-jupyterlab-build-cpu-saturate.html">2018-07-30 JupyterLab builds saturate BinderHub CPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-07-08-podsnips-aplenty.html">2018-07-08, too many pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-04-18-cull-flood.html">2018-04-18, Culler flood</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-31-server-start-fail.html">2018-03-31, Server launch failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-26-no-space-left.html">2018-03-26, “no space left on device”</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-13-PVC-hub-locked.html">2018-03-13, PVC for hub is locked</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-22-nginx-down.html">2018-02-22 NGINX crash</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-20-jupyterlab-announcement.html">2018-02-20, JupyterLab Announcement swamps Binder</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-12-launch-fail.html">2018-02-12, Hub Launch Fail</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-18-reddit-hug.html">2018-01-18, reddit hugs mybinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-18-ssl-outdated.html">2018-01-11, Warning from letsencrypt about outdated SSL certificate</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-17-ubuntu-upgrade.html">2018-01-17, Emergency Aardvark bump</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-04-failed-staging-deploy.html">2018-01-04, Failed deploy to staging</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-11-30-oom-proxy.html">2017-11-30 4:23PM PST, OOM (Out of Memory) Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-10-17-cluster-full.html">2017-10-17, Cluster Full</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-09-29-504.html">2017-09-29, 504</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-09-27-hub-403.html">2017-09-27, Hub 403</a></li>
<li class="toctree-l1"><a class="reference internal" href="template-incident-report.html">Template for reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="template-incident-report.html#incident-date-yyyy-mm-dd-incident-name">{{ incident date: yyyy-mm-dd }}, {{ incident name }}</a></li>
</ul>


<div class="relations">
<h3>Navigation</h3>
<ul>
  <li><a href="../index.html">Documentation Home</a><ul>
  <li><a href="2019-03-24-r2d-upgrade.html" title="Previous">Previous topic</a></li>
  <li><a href="2018-07-30-jupyterlab-build-cpu-saturate.html" title="Next">Next topic</a></li>
  </ul>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/incident-reports/2019-02-20-no-logs.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
        <form class="search" action="../search.html" method="get">
            <input type="text" name="q" placeholder="Quick Search" aria-labelledby="searchlabel" />
            <input type="submit" value="Go" />
        </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017 - 2019, Binder Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/incident-reports/2019-02-20-no-logs.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>