
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>2019-03-24, repo2docker upgrade and docker image cache wipe &#8212; Site Reliability Guide for mybinder.org 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="incident date: 2019-02-20, kubectl logs unavailable" href="2019-02-20-no-logs.html" />
    <link rel="prev" title="2019-04-03, 30min outage during node pool upgrade" href="2019-04-03-ingress-cordoned.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<!-- Add JupyterHub styling -->
<link rel="stylesheet" href="../_static/jupyter.css" type="text/css" />
<link rel="shortcut icon" href="../_static/favicon.ico"/>


  </head><body>
<div class="rightsidebar">
    <h3>On this page</h3>
    <ul>
<li><a class="reference internal" href="#">2019-03-24, repo2docker upgrade and docker image cache wipe</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#timeline">Timeline</a><ul>
<li><a class="reference internal" href="#">2019-03-24 8:54</a></li>
<li><a class="reference internal" href="#">18:45</a></li>
<li><a class="reference internal" href="#">18:54</a></li>
<li><a class="reference internal" href="#">19:14</a></li>
<li><a class="reference internal" href="#">19:57</a></li>
<li><a class="reference internal" href="#">22:18</a></li>
<li><a class="reference internal" href="#">22:36</a></li>
<li><a class="reference internal" href="#am">2019-03-25 7:01am</a></li>
</ul>
</li>
<li><a class="reference internal" href="#lessons-learnt">Lessons learnt</a><ul>
<li><a class="reference internal" href="#what-went-well">What went well</a></li>
<li><a class="reference internal" href="#what-went-wrong">What went wrong</a></li>
<li><a class="reference internal" href="#where-we-got-lucky">Where we got lucky</a></li>
</ul>
</li>
<li><a class="reference internal" href="#action-items">Action items</a><ul>
<li><a class="reference internal" href="#process-improvements">Process improvements</a></li>
<li><a class="reference internal" href="#documentation-improvements">Documentation improvements</a></li>
<li><a class="reference internal" href="#technical-improvements">Technical improvements</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
   <div class='prev-next-top'>
     
      <a class='left-prev' href="2019-04-03-ingress-cordoned.html" title="previous chapter">Previous</a>
      <a class='right-next' href="2019-02-20-no-logs.html" title="next chapter">Next</a>
   <div style='clear:both;'></div>
 
   </div>


          <div class="body" role="main">
            
  <div class="section" id="repo2docker-upgrade-and-docker-image-cache-wipe">
<span id="repo2docker-upgrade-and-docker-image-cache-wipe"></span><h1>2019-03-24, repo2docker upgrade and docker image cache wipe<a class="headerlink" href="#repo2docker-upgrade-and-docker-image-cache-wipe" title="Permalink to this headline">¶</a></h1>
<div class="section" id="summary">
<span id="summary"></span><h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>User’s experienced long wait times for the images to build, fixed by banning
the JupyterLab demo repository. The problem was that a single repository that
is very popular and takes a long time to build will end up consuming all
available “build slots”. Incident lasted most on Sunday day in Europe.</p>
</div>
<div class="section" id="timeline">
<span id="timeline"></span><h2>Timeline<a class="headerlink" href="#timeline" title="Permalink to this headline">¶</a></h2>
<p>All times in UTC+1 (Zurich time)</p>
<div class="section" id="">
<span id="id1"></span><h3>2019-03-24 8:54<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Start of incident. New version of repo2docker is deployed and the build prefix
is bumped. This effectively clears the docker image cache. Repositories start
building. We quickly accumulate build pods. Things appear to work.</p>
<p><img alt="" src="incident-reports/../../_static/images/r2d-incident-build-pods.png" /></p>
</div>
<div class="section" id="">
<span id="id2"></span><h3>18:45<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Builds are backlogged. As not a lot of binders are running the auto-scaled
cluster is small which limits the amount of resources available to build images.
Decision taken to add two new nodes to provide additional
resources for building pods</p>
<p><img alt="" src="incident-reports/../../_static/images/r2d-incident-build-pods-24h.png" /></p>
</div>
<div class="section" id="">
<span id="id3"></span><h3>18:54<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Two new nodes were added as a separate node pool. These nodes had no “Local SSD”
assigned to them. This was a mistake in setting up the node pool.</p>
</div>
<div class="section" id="">
<span id="id4"></span><h3>19:14<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>New builds weren’t starting, number of running build pods kept decreasing.
When triggering a new build and watching the logs we never see a log message
that the build pod has been launched. This is consistent with the UI on the web
interface. However unclear why the build pods are not being launch.</p>
<p>Suspect something is “stuck” in the BinderHub
pods, restarted one of them. New builds start happening.</p>
</div>
<div class="section" id="">
<span id="id5"></span><h3>19:57<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Reports of builds happening but then erroring with “no disk space”, images
are not pushed to the registry. Notice that the extra node pool does not have
local SSD drives after ssh’ing to some old and new nodes and comparing output
of <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">-h</span></code> on each. Recreate node pool with correctly configured nodes.</p>
<p>Restarted the second bhub pod.</p>
</div>
<div class="section" id="">
<span id="id6"></span><h3>22:18<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Notice that builds are not starting and number of running build pods is low.</p>
<p>Start investigating where the builds are queued. Added a new metric to the
“Running Build Pods” chart on grafana to show number of builds “started” by
BinderHub.</p>
<p><img alt="" src="incident-reports/../../_static/images/r2d-incident-build-pods-zoom.png" /></p>
<p>Each “build” is either someone requesting a repository that has not been built
or is in the process of being built. The number of actually running builds keeps
decreasing over time, while the number of “started builds” keeps growing. The
big drop is when we deleted the build pod for the JupyterLab demo repository</p>
</div>
<div class="section" id="">
<span id="id7"></span><h3>22:36<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Decide to start a build for JupyterLab demo repo and then ban it to allow
other repository builds to make progress. Once the JLab build is done we will
unban it again.</p>
</div>
<div class="section" id="am">
<span id="am"></span><h3>2019-03-25 7:01am<a class="headerlink" href="#am" title="Permalink to this headline">¶</a></h3>
<p>JupyterLab demo repo build completed, repository was unbanned again.
Incident resolved.</p>
</div>
</div>
<div class="section" id="lessons-learnt">
<span id="lessons-learnt"></span><h2>Lessons learnt<a class="headerlink" href="#lessons-learnt" title="Permalink to this headline">¶</a></h2>
<div class="section" id="what-went-well">
<span id="what-went-well"></span><h3>What went well<a class="headerlink" href="#what-went-well" title="Permalink to this headline">¶</a></h3>
<p>List of things that went well. For example,</p>
<ol class="simple">
<li><p>We managed to update repo2docker and wipe the build cache without causing
a total outage.</p></li>
</ol>
</div>
<div class="section" id="what-went-wrong">
<span id="what-went-wrong"></span><h3>What went wrong<a class="headerlink" href="#what-went-wrong" title="Permalink to this headline">¶</a></h3>
<p>Things that could have gone better. Ideally these should result in concrete
action items that have GitHub issues created for them and linked to under
Action items. For example,</p>
<ol class="simple">
<li><p>We generate a lot of load when wiping the cache and had no ready-to-go
instructions for adding extra nodes to the cluster.</p></li>
</ol>
</div>
<div class="section" id="where-we-got-lucky">
<span id="where-we-got-lucky"></span><h3>Where we got lucky<a class="headerlink" href="#where-we-got-lucky" title="Permalink to this headline">¶</a></h3>
<p>These are good things that happened to us but not because we had planned for them.
For example,</p>
<ol class="simple">
<li><p>Users were super understanding and supportive that things were slow and builds
did not start for several hours.</p></li>
</ol>
</div>
</div>
<div class="section" id="action-items">
<span id="action-items"></span><h2>Action items<a class="headerlink" href="#action-items" title="Permalink to this headline">¶</a></h2>
<div class="section" id="process-improvements">
<span id="process-improvements"></span><h3>Process improvements<a class="headerlink" href="#process-improvements" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Need to devise a strategy for wiping the build cache without generating a huge
load.</p></li>
</ol>
</div>
<div class="section" id="documentation-improvements">
<span id="documentation-improvements"></span><h3>Documentation improvements<a class="headerlink" href="#documentation-improvements" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Add a command that can be copy&amp;pasted to add a new node pool to avoid
configuration errors.</p></li>
</ol>
</div>
<div class="section" id="technical-improvements">
<span id="technical-improvements"></span><h3>Technical improvements<a class="headerlink" href="#technical-improvements" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Change our build thread pool setup so that a single slow to build and popular
repository does not end up using all available build slots.</p></li>
</ol>
</div>
</div>
</div>


          </div>
   <div class='prev-next-bottom'>
     
      <a class='left-prev' href="2019-04-03-ingress-cordoned.html" title="previous chapter">2019-04-03, 30min outage during node pool upgrade</a>
      <a class='right-next' href="2019-02-20-no-logs.html" title="next chapter">incident date: 2019-02-20, kubectl logs unavailable</a>
   <div style='clear:both;'></div>
 
   </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <p class="logo"><a href="../index.html">
    <img class="logo" src="../_static/logo.jpg" alt="Logo"/>
  </a></p>
<h1 class="logo"><a href="../index.html">Site Reliability Guide for mybinder.org</a></h1>



<p class="blurb">A Site Reliability Guide for mybinder.org deployment</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jupyterhub&repo=binderhub&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<h3>Table of Contents</h3>
<p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with the <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code> dev team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../production_environment.html">Production environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminology.html">Terminology for the deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deployment/prereqs.html">Pre-requisite technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/how.html">How to deploy a change to mybinder.org?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/what.html">What does a MyBinder.org deployment do?</a></li>
</ul>
<p class="caption"><span class="caption-text">Operation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../common_problems.html">Common problems and their solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_snippets.html">Command snippets used during operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grafana_plots.html">Some useful Grafana plots</a></li>
<li class="toctree-l1"><a class="reference internal" href="../federation.html">The mybinder.org Federation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/metrics.html">Metrics collection with Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/dashboards.html">Operational Dashboards with Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/ingress.html">HTTPS ingress with nginx + kube-lego</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/cloud.html">Cloud products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/matomo.html">Matomo (formerly Piwik) analytics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../analytics/events-archive.html">The Analytics Events Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analytics/cloud-costs.html">Cloud Costs Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Incidents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="2019-04-03-ingress-cordoned.html">2019-04-03, 30min outage during node pool upgrade</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2019-03-24, repo2docker upgrade and docker image cache wipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="2019-02-20-no-logs.html">incident date: 2019-02-20, kubectl logs unavailable</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-07-30-jupyterlab-build-cpu-saturate.html">2018-07-30 JupyterLab builds saturate BinderHub CPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-07-08-podsnips-aplenty.html">2018-07-08, too many pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-04-18-cull-flood.html">2018-04-18, Culler flood</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-31-server-start-fail.html">2018-03-31, Server launch failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-26-no-space-left.html">2018-03-26, “no space left on device”</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-13-PVC-hub-locked.html">2018-03-13, PVC for hub is locked</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-22-nginx-down.html">2018-02-22 NGINX crash</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-20-jupyterlab-announcement.html">2018-02-20, JupyterLab Announcement swamps Binder</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-12-launch-fail.html">2018-02-12, Hub Launch Fail</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-18-reddit-hug.html">2018-01-18, reddit hugs mybinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-18-ssl-outdated.html">2018-01-11, Warning from letsencrypt about outdated SSL certificate</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-17-ubuntu-upgrade.html">2018-01-17, Emergency Aardvark bump</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-04-failed-staging-deploy.html">2018-01-04, Failed deploy to staging</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-11-30-oom-proxy.html">2017-11-30 4:23PM PST, OOM (Out of Memory) Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-10-17-cluster-full.html">2017-10-17, Cluster Full</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-09-29-504.html">2017-09-29, 504</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-09-27-hub-403.html">2017-09-27, Hub 403</a></li>
<li class="toctree-l1"><a class="reference internal" href="template-incident-report.html">Template for reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="template-incident-report.html#incident-date-yyyy-mm-dd-incident-name">{{ incident date: yyyy-mm-dd }}, {{ incident name }}</a></li>
</ul>


<div class="relations">
<h3>Navigation</h3>
<ul>
  <li><a href="../index.html">Documentation Home</a><ul>
  <li><a href="2019-04-03-ingress-cordoned.html" title="Previous">Previous topic</a></li>
  <li><a href="2019-02-20-no-logs.html" title="Next">Next topic</a></li>
  </ul>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/incident-reports/2019-03-24-r2d-upgrade.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
        <form class="search" action="../search.html" method="get">
            <input type="text" name="q" placeholder="Quick Search" aria-labelledby="searchlabel" />
            <input type="submit" value="Go" />
        </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017 - 2019, Binder Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/incident-reports/2019-03-24-r2d-upgrade.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>