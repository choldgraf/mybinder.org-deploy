
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>2017-09-27, Hub 403 &#8212; Site Reliability Guide for mybinder.org 1.0 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Template for reports" href="template-incident-report.html" />
    <link rel="prev" title="2017-09-29, 504" href="2017-09-29-504.html" />

   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<!-- Add JupyterHub styling -->
<link rel="stylesheet" href="../_static/jupyter.css" type="text/css" />
<link rel="shortcut icon" href="../_static/favicon.ico"/>


  </head><body>
<div class="rightsidebar">
    <h3>On this page</h3>
    <ul>
<li><a class="reference internal" href="#">2017-09-27, Hub 403</a><ul>
<li><a class="reference internal" href="#summary">Summary</a></li>
<li><a class="reference internal" href="#timeline">Timeline</a><ul>
<li><a class="reference internal" href="#sep-27-2017-13-06">Sep 27 2017 13:06</a></li>
<li><a class="reference internal" href="#">13:35</a></li>
<li><a class="reference internal" href="#">13:44</a></li>
<li><a class="reference internal" href="#">14:08</a></li>
<li><a class="reference internal" href="#">15:11</a></li>
<li><a class="reference internal" href="#">15:25</a></li>
</ul>
</li>
<li><a class="reference internal" href="#conclusion">Conclusion</a></li>
<li><a class="reference internal" href="#action-items">Action Items</a><ul>
<li><a class="reference internal" href="#binderhub">BinderHub</a></li>
<li><a class="reference internal" href="#deployment">Deployment</a></li>
<li><a class="reference internal" href="#local-development">Local development</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
   <div class='prev-next-top'>
     
      <a class='left-prev' href="2017-09-29-504.html" title="previous chapter">Previous</a>
      <a class='right-next' href="template-incident-report.html" title="next chapter">Next</a>
   <div style='clear:both;'></div>
 
   </div>


          <div class="body" role="main">
            
  <div class="section" id="hub-403">
<span id="hub-403"></span><h1>2017-09-27, Hub 403<a class="headerlink" href="#hub-403" title="Permalink to this headline">¶</a></h1>
<div class="section" id="summary">
<span id="summary"></span><h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>After a deployment, most users were getting a ‘403 Forbidden’ when attempting to
launch their image. This was caused by a small bug that manifests only on
multi-node kubernetes clusters. The bug was identified and fixed, but due to
logistical issues it caused beta to be unusable for about 1h50m.</p>
</div>
<div class="section" id="timeline">
<span id="timeline"></span><h2>Timeline<a class="headerlink" href="#timeline" title="Permalink to this headline">¶</a></h2>
<p>All times in PST</p>
<div class="section" id="sep-27-2017-13-06">
<span id="sep-27-2017-13-06"></span><h3>Sep 27 2017 13:06<a class="headerlink" href="#sep-27-2017-13-06" title="Permalink to this headline">¶</a></h3>
<p>A lot of changes related to
<a class="reference external" href="https://github.com/jupyterhub/binderhub/issues/94">launching the user servers with hub api</a>
are deployed to staging. Testing caused a ‘403 Forbidden’ on the first try, but
worked on second try. This was attributed to the mysterious ‘oh must have been
stale cookies’ reason, and not counted as a problem. Deployment proceeds.</p>
</div>
<div class="section" id="">
<span id="id1"></span><h3>13:35<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Deployment to beta is complete! ‘403 Forbidden’ recurs once, but works the
second time - again attributed to ‘stale cookies’. Some cluster maintenance work
is then begun:</p>
<ol class="simple">
<li><p>Make sure cluster nodes have SSDs</p></li>
<li><p>Make sure cluster nodes have large SSDs (500G, not 100G) for better
performance, since on Google Cloud disk performance scales with disk size.</p></li>
</ol>
<p>These take a while. It also looked like two of the three nodes present were
having disk trouble, so it seemed a good time to roll ‘em over (without doing
too much investigation).</p>
</div>
<div class="section" id="">
<span id="id2"></span><h3>13:44<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>‘403 Forbidden’ reported by others, and it does not clear on second try. All
nodes now are new, so this is unrelated to nodes having issues. Within a few
minutes, it is clear that the ‘403 Forbidden’ does not go away after first use,
and we should consider beta as ‘broken’ now.</p>
</div>
<div class="section" id="">
<span id="id3"></span><h3>14:08<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>Digging into logs and attempts to reproduce this yield the following
conclusions:</p>
<ol class="simple">
<li><p>It works when the server starts up within 10s (thus not triggering the
‘server is slow to spawn’ message in hub logs)</p></li>
<li><p>It leads to 403 when the server takes longer than 10s.</p></li>
</ol>
<p>A quick look at the code made the problem clear:</p>
<ol class="simple">
<li><p>If the spawn takes more than 10s, the hub returns a <code class="docutils literal notranslate"><span class="pre">202</span></code> status code, and we
then have to poll to see when our server has started.</p></li>
<li><p>In binderhub, we were not doing this polling. We instead prematurely redirect
to the hub, which freaks out at the non-running server and gives us the 403.
This is because we
use <a class="reference external" href="https://github.com/jupyterhub/nullauthenticator">nullauthenticator</a> for
the hub, whose sole job is to 403 every user not already logged in somehow!</p></li>
</ol>
<p>This diagnosis was a little confused by the following facts:</p>
<ol>
<li><p>We also upgraded from JupyterHub 0.7 to 0.8 with this deployment, and decided
to just wipe out the user db than upgrade it. This caused a lot of messages
of the following form:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[W 2017-09-28 16:20:51.785 JupyterHub base:350] Failed login for unknown user
[W 2017-09-28 16:20:51.787 JupyterHub log:122] 403 GET /hub/login?next=%2Fhub%2Fuser%2F13b14ca5-5c6b-4340-8157-651ad95a2739%2Fapi%2Fcontents%2Fnotebooks%2Fxwidgets.ipynb%3Fcontent%3D0%26_%3D1506507345627 (@10.100.16.12) 2.00ms
</pre></div>
</div>
<p>These were red herrings, just failures for people who were unceremoniously
booted off during the deploy.</p>
</li>
<li><p>In cluster, most images had already been locally cached. So some images would
launch under 10s, hence not causing the 403. This made tracking down cause a
little harder than if it failed consistently.</p></li>
<li><p>This would not be reproducible on minikube without artificial constraints,
since it does not use a registry &amp; the build host is always the same as the
run host.</p></li>
</ol>
<p>Once it was clear what the issue was, the fix seemed obvious enough.</p>
</div>
<div class="section" id="">
<span id="id4"></span><h3>15:11<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>A <a class="reference external" href="https://github.com/jupyterhub/binderhub/pull/130">PR</a> is sent up with the
fix. It isn’t as configurable as it should be, but should work. This is delayed
by the fact that the deployer’s local minikube had run out of space &amp; needed to
be reset.</p>
</div>
<div class="section" id="">
<span id="id5"></span><h3>15:25<a class="headerlink" href="#" title="Permalink to this headline">¶</a></h3>
<p>The PR has been merged and deployed, bringing the outage to an end.</p>
</div>
</div>
<div class="section" id="conclusion">
<span id="conclusion"></span><h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h2>
<p>This was caused by two factors:</p>
<ol class="simple">
<li><p>Local development environment being slightly different from production
environment (single node vs multi node)</p></li>
<li><p>Testing in staging not thorough enough</p></li>
</ol>
<p>Debugging this was complicated by the fact we changed a lot of things at the
same time (JupyterHub version, binder code, etc). This was a big breaking change
that required us to kick users out. We should try to not do those.</p>
</div>
<div class="section" id="action-items">
<span id="action-items"></span><h2>Action Items<a class="headerlink" href="#action-items" title="Permalink to this headline">¶</a></h2>
<div class="section" id="binderhub">
<span id="binderhub"></span><h3>BinderHub<a class="headerlink" href="#binderhub" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Handle errors on launching servers on the hub more gracefully.
<a class="reference external" href="https://github.com/jupyterhub/binderhub/issues/131">Issue</a></p></li>
</ol>
</div>
<div class="section" id="deployment">
<span id="deployment"></span><h3>Deployment<a class="headerlink" href="#deployment" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Write end-to-end tests that help validate that a deployment was successful,
and make sure they are part of marking a deployment green or red.
<a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/10">Issue</a></p></li>
<li><p>Write down the responsibilities of the people doing the deployment.
Specifically include the lesson of ‘never ignore any errors in staging, they
will always bite you in production’ prominently.
<a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/11">Issue</a></p></li>
<li><p>Do deployments more often so we don’t end up doing one big massive deployment
ever. Those will always cause problems. Easier deployments with better
tooling will help this. <a class="reference external" href="https://github.com/jupyterhub/mybinder.org-deploy/issues/8">Issue</a></p></li>
</ol>
</div>
<div class="section" id="local-development">
<span id="local-development"></span><h3>Local development<a class="headerlink" href="#local-development" title="Permalink to this headline">¶</a></h3>
<ol class="simple">
<li><p>Consider figuring out an easy way for people to run a development environment
that is closer to production (multi-node, image registry, etc) than minikube.
<a class="reference external" href="https://github.com/jupyterhub/binderhub/issues/137">Issue</a></p></li>
</ol>
</div>
</div>
</div>


          </div>
   <div class='prev-next-bottom'>
     
      <a class='left-prev' href="2017-09-29-504.html" title="previous chapter">2017-09-29, 504</a>
      <a class='right-next' href="template-incident-report.html" title="next chapter">Template for reports</a>
   <div style='clear:both;'></div>
 
   </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <p class="logo"><a href="../index.html">
    <img class="logo" src="../_static/logo.jpg" alt="Logo"/>
  </a></p>
<h1 class="logo"><a href="../index.html">Site Reliability Guide for mybinder.org</a></h1>



<p class="blurb">A Site Reliability Guide for mybinder.org deployment</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jupyterhub&repo=binderhub&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<h3>Table of Contents</h3>
<p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started.html">Getting started with the <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code> dev team</a></li>
<li class="toctree-l1"><a class="reference internal" href="../production_environment.html">Production environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../terminology.html">Terminology for the deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deployment/prereqs.html">Pre-requisite technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/how.html">How to deploy a change to mybinder.org?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deployment/what.html">What does a MyBinder.org deployment do?</a></li>
</ul>
<p class="caption"><span class="caption-text">Operation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../common_problems.html">Common problems and their solutions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../command_snippets.html">Command snippets used during operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../grafana_plots.html">Some useful Grafana plots</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../components/metrics.html">Metrics collection with Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/dashboards.html">Operational Dashboards with Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/ingress.html">HTTPS ingress with nginx + kube-lego</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/cloud.html">Cloud products</a></li>
<li class="toctree-l1"><a class="reference internal" href="../components/matomo.html">Matomo (formerly Piwik) analytics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../analytics/events-archive.html">The Analytics Events Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../analytics/cloud-costs.html">Cloud Costs Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Incidents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="2019-04-03-ingress-cordoned.html">2019-04-03, 30min outage during node pool upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="2019-03-24-r2d-upgrade.html">2019-03-24, repo2docker upgrade and docker image cache wipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="2019-02-20-no-logs.html">incident date: 2019-02-20, kubectl logs unavailable</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-07-30-jupyterlab-build-cpu-saturate.html">2018-07-30 JupyterLab builds saturate BinderHub CPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-07-08-podsnips-aplenty.html">2018-07-08, too many pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-04-18-cull-flood.html">2018-04-18, Culler flood</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-31-server-start-fail.html">2018-03-31, Server launch failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-26-no-space-left.html">2018-03-26, “no space left on device”</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-03-13-PVC-hub-locked.html">2018-03-13, PVC for hub is locked</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-22-nginx-down.html">2018-02-22 NGINX crash</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-20-jupyterlab-announcement.html">2018-02-20, JupyterLab Announcement swamps Binder</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-02-12-launch-fail.html">2018-02-12, Hub Launch Fail</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-18-reddit-hug.html">2018-01-18, reddit hugs mybinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-18-ssl-outdated.html">2018-01-11, Warning from letsencrypt about outdated SSL certificate</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-17-ubuntu-upgrade.html">2018-01-17, Emergency Aardvark bump</a></li>
<li class="toctree-l1"><a class="reference internal" href="2018-01-04-failed-staging-deploy.html">2018-01-04, Failed deploy to staging</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-11-30-oom-proxy.html">2017-11-30 4:23PM PST, OOM (Out of Memory) Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-10-17-cluster-full.html">2017-10-17, Cluster Full</a></li>
<li class="toctree-l1"><a class="reference internal" href="2017-09-29-504.html">2017-09-29, 504</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">2017-09-27, Hub 403</a></li>
<li class="toctree-l1"><a class="reference internal" href="template-incident-report.html">Template for reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="template-incident-report.html#incident-date-yyyy-mm-dd-incident-name">{{ incident date: yyyy-mm-dd }}, {{ incident name }}</a></li>
</ul>


<div class="relations">
<h3>Navigation</h3>
<ul>
  <li><a href="../index.html">Documentation Home</a><ul>
  <li><a href="2017-09-29-504.html" title="Previous">Previous topic</a></li>
  <li><a href="template-incident-report.html" title="Next">Next topic</a></li>
  </ul>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/incident-reports/2017-09-27-hub-403.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
        <form class="search" action="../search.html" method="get">
            <input type="text" name="q" placeholder="Quick Search" aria-labelledby="searchlabel" />
            <input type="submit" value="Go" />
        </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017 - 2019, Binder Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/incident-reports/2017-09-27-hub-403.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>