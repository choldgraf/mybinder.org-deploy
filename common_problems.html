
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Common problems and their solutions &#8212; Site Reliability Guide for mybinder.org 1.0 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Command snippets used during operations" href="command_snippets.html" />
    <link rel="prev" title="What does a MyBinder.org deployment do?" href="deployment/what.html" />

   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

<!-- Add JupyterHub styling -->
<link rel="stylesheet" href="_static/jupyter.css" type="text/css" />
<link rel="shortcut icon" href="_static/favicon.ico"/>


  </head><body>
<div class="rightsidebar">
    <h3>On this page</h3>
    <ul>
<li><a class="reference internal" href="#">Common problems and their solutions</a><ul>
<li><a class="reference internal" href="#the-docker-in-docker-socket">The Docker-in-Docker socket</a><ul>
<li><a class="reference internal" href="#how-to-spot-the-problem">How to spot the problem</a></li>
<li><a class="reference internal" href="#how-to-resolve-the-problem">How to resolve the problem</a></li>
</ul>
</li>
<li><a class="reference internal" href="#networking-errors">Networking Errors</a><ul>
<li><a class="reference internal" href="#manually-confirm-network-between-pods-is-working">Manually confirm network between pods is working</a></li>
<li><a class="reference internal" href="#spikes-in-traffic">Spikes in traffic</a><ul>
<li><a class="reference internal" href="#spikes-to-mybinder-org">Spikes to <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code></a></li>
<li><a class="reference internal" href="#spikes-to-the-build-api">Spikes to the <code class="docutils literal notranslate"><span class="pre">/build</span></code> API</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>


    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
   <div class='prev-next-top'>
     
      <a class='left-prev' href="deployment/what.html" title="previous chapter">Previous</a>
      <a class='right-next' href="command_snippets.html" title="next chapter">Next</a>
   <div style='clear:both;'></div>
 
   </div>


          <div class="body" role="main">
            
  <div class="section" id="common-problems-and-their-solutions">
<span id="common-problems-and-their-solutions"></span><h1>Common problems and their solutions<a class="headerlink" href="#common-problems-and-their-solutions" title="Permalink to this headline">¶</a></h1>
<p>This is a page to list a few of the common problems that we run into during
operation of <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code>, and some common solutions that solve these
problems. In general, <strong>manual intervention</strong> is something that we should
avoid requiring, but sometimes it is necessary. This page serves as a helpful
guide for people maintaining <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code>, and an informal list of things
we should design new technology to fix.</p>
<div class="section" id="the-docker-in-docker-socket">
<span id="the-docker-in-docker-socket"></span><h2>The Docker-in-Docker socket<a class="headerlink" href="#the-docker-in-docker-socket" title="Permalink to this headline">¶</a></h2>
<p>When using Docker-in-Docker, there is a chance that <code class="docutils literal notranslate"><span class="pre">dind</span></code> hasn’t started when a
build is requested. If this happens, the volume mount to load
<code class="docutils literal notranslate"><span class="pre">/var/run/dind/docker.sock</span></code> into the build container may occur before <code class="docutils literal notranslate"><span class="pre">dind</span></code>
has created the socket. If this happens, the volume mount will create a
directory at the mount point (which we don’t want to happen). If this happens,
Docker-in-Docker will be inaccessible until <code class="docutils literal notranslate"><span class="pre">/var/run/dind</span></code> is manually deleted
and the <code class="docutils literal notranslate"><span class="pre">dind</span></code> pod is restarted.</p>
<div class="section" id="how-to-spot-the-problem">
<span id="how-to-spot-the-problem"></span><h3>How to spot the problem<a class="headerlink" href="#how-to-spot-the-problem" title="Permalink to this headline">¶</a></h3>
<p>Build pods will not be working, and the <code class="docutils literal notranslate"><span class="pre">dind</span></code> pods are stuck in <code class="docutils literal notranslate"><span class="pre">CrashLoopBackoff</span></code>.</p>
</div>
<div class="section" id="how-to-resolve-the-problem">
<span id="how-to-resolve-the-problem"></span><h3>How to resolve the problem<a class="headerlink" href="#how-to-resolve-the-problem" title="Permalink to this headline">¶</a></h3>
<ol>
<li><p>Find out which node contains the crashing <code class="docutils literal notranslate"><span class="pre">dind</span></code> pod (aka, the node that has
<em>folder</em> in <code class="docutils literal notranslate"><span class="pre">/var/run/dind/docker.sock</span></code> rather than the socket file).
You can do so by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=&lt;</span><span class="n">ns</span><span class="o">&gt;</span> <span class="n">get</span> <span class="n">pod</span> <span class="o">-</span><span class="n">o</span> <span class="n">wide</span>
</pre></div>
</div>
</li>
<li><p>Once you find the node of interest, SSH into it with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gcloud</span> <span class="n">compute</span> <span class="n">ssh</span> <span class="o">&lt;</span><span class="n">nodename</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
<li><p>Manually delete the <code class="docutils literal notranslate"><span class="pre">docker.sock</span></code> folder from the node.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">dind</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">sock</span><span class="o">/</span>
</pre></div>
</div>
</li>
<li><p>Delete the <code class="docutils literal notranslate"><span class="pre">dind</span></code> pod (k8s will automatically create a new one)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=&lt;</span><span class="n">ns</span><span class="o">&gt;</span> <span class="n">delete</span> <span class="n">pod</span> <span class="o">&lt;</span><span class="n">dind</span><span class="o">-</span><span class="n">pod</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="networking-errors">
<span id="networking-errors"></span><h2>Networking Errors<a class="headerlink" href="#networking-errors" title="Permalink to this headline">¶</a></h2>
<p>Sometimes there are networking errors between pods, or between one pod and
all other pods. This section covers how to debug and correct for networking
on the Kubernetes deployment.</p>
<div class="section" id="manually-confirm-network-between-pods-is-working">
<span id="manually-confirm-network-between-pods-is-working"></span><h3>Manually confirm network between pods is working<a class="headerlink" href="#manually-confirm-network-between-pods-is-working" title="Permalink to this headline">¶</a></h3>
<p>To confirm that binderhub can talk to jupyterhub, to the internet in general, or
you want to confirm for yourself that there is no connectivity problem between
pods follow this recipe.</p>
<ol class="simple">
<li><p>connect to the pod you want to use as “source”, for example the jupyterhub
pod: <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">--namespace=prod</span> <span class="pre">exec</span> <span class="pre">-it</span> <span class="pre">hub-989cc9bd-bbkbk</span> <span class="pre">/bin/bash</span></code></p></li>
<li><p>start <code class="docutils literal notranslate"><span class="pre">python3</span></code>, <code class="docutils literal notranslate"><span class="pre">import</span> <span class="pre">requests</span></code></p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">requests.get(host)</span></code> to check connectivity. Some interesting hostnames
to try talking to are:</p>
<ul class="simple">
<li><p>http://binder/, the binderhub service</p></li>
<li><p>http://hub:8081/hub/api, the jupyterhub API</p></li>
<li><p>http://proxy-public/hub/api, the CHP route that redirects you to the
jupyterhub API (content of the response should be equal)</p></li>
<li><p>http://google.com/, the internet</p></li>
<li><p>the CHP API needs a token so run: <code class="docutils literal notranslate"><span class="pre">headers={'Authorization':</span> <span class="pre">'token</span> <span class="pre">'</span> <span class="pre">+</span> <span class="pre">os.environ['CONFIGPROXY_AUTH_TOKEN']}</span></code>
and then<code class="docutils literal notranslate"><span class="pre">requests.get('http://proxy-api:8001/api/routes',</span> <span class="pre">headers=headers)</span></code></p></li>
<li><p>Other hostnames within the Kubernetes deployment. To find out hostnames
to try look at the <code class="docutils literal notranslate"><span class="pre">metadata.name</span></code> field of a kubernetes
service in the helm chart. You should be able to connect to each of them using
the name as the hostname. Take care to use the right port, not all of them are
listening on 80.</p></li>
</ul>
</li>
</ol>
<p>Here’s a code snippet to try all of the above in quick succession:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;binder/&quot;</span><span class="p">,</span> <span class="s2">&quot;hub:8081/hub/api&quot;</span><span class="p">,</span> <span class="s2">&quot;proxy-public/hub/api&quot;</span><span class="p">,</span> <span class="s2">&quot;google.com/&quot;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">urls</span><span class="p">:</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;http://&quot;</span> <span class="o">+</span> <span class="n">url</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;{}: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">resp</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="spikes-in-traffic">
<span id="spikes-in-traffic"></span><h3>Spikes in traffic<a class="headerlink" href="#spikes-in-traffic" title="Permalink to this headline">¶</a></h3>
<p>Spikes in traffic can cause congestion, slowness, or surface bugs in the
deployment. Here are some ways to detect spikes.</p>
<div class="section" id="spikes-to-mybinder-org">
<span id="spikes-to-mybinder-org"></span><h4>Spikes to <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code><a class="headerlink" href="#spikes-to-mybinder-org" title="Permalink to this headline">¶</a></h4>
<p>Spikes to <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code> are most-easily detected by going to the project’s
Google Analytics page. Look at the “real-time” page and see if there is a big
shift from typical patterns of behavior.</p>
</div>
<div class="section" id="spikes-to-the-build-api">
<span id="spikes-to-the-build-api"></span><h4>Spikes to the <code class="docutils literal notranslate"><span class="pre">/build</span></code> API<a class="headerlink" href="#spikes-to-the-build-api" title="Permalink to this headline">¶</a></h4>
<p>Sometimes there are spikes to the BinderHub build API, which we cannot capture
with Google Analytics. Spikes to the build API usually come from a single
repository, and can be found with the following command.</p>
<p>To list the API requests to <code class="docutils literal notranslate"><span class="pre">/build</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">prod</span> <span class="n">logs</span> <span class="o">-</span><span class="n">l</span> <span class="n">component</span><span class="o">=</span><span class="n">controller</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;/build&#39;</span>
</pre></div>
</div>
<p>and to list the number of API requests to <code class="docutils literal notranslate"><span class="pre">/build</span></code> that contain a particular
word:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">kubectl</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">prod</span> <span class="n">logs</span> <span class="o">-</span><span class="n">l</span> <span class="n">component</span><span class="o">=</span><span class="n">controller</span> <span class="o">|</span> <span class="n">grep</span> <span class="s1">&#39;/build&#39;</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">&lt;</span><span class="n">word</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>


          </div>
   <div class='prev-next-bottom'>
     
      <a class='left-prev' href="deployment/what.html" title="previous chapter">What does a MyBinder.org deployment do?</a>
      <a class='right-next' href="command_snippets.html" title="next chapter">Command snippets used during operations</a>
   <div style='clear:both;'></div>
 
   </div>

        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <p class="logo"><a href="index.html">
    <img class="logo" src="_static/logo.jpg" alt="Logo"/>
  </a></p>
<h1 class="logo"><a href="index.html">Site Reliability Guide for mybinder.org</a></h1>



<p class="blurb">A Site Reliability Guide for mybinder.org deployment</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jupyterhub&repo=binderhub&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<h3>Table of Contents</h3>
<p class="caption"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started with the <code class="docutils literal notranslate"><span class="pre">mybinder.org</span></code> dev team</a></li>
<li class="toctree-l1"><a class="reference internal" href="production_environment.html">Production environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="terminology.html">Terminology for the deployment</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="deployment/prereqs.html">Pre-requisite technologies</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment/how.html">How to deploy a change to mybinder.org?</a></li>
<li class="toctree-l1"><a class="reference internal" href="deployment/what.html">What does a MyBinder.org deployment do?</a></li>
</ul>
<p class="caption"><span class="caption-text">Operation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Common problems and their solutions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-docker-in-docker-socket">The Docker-in-Docker socket</a></li>
<li class="toctree-l2"><a class="reference internal" href="#networking-errors">Networking Errors</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="command_snippets.html">Command snippets used during operations</a></li>
<li class="toctree-l1"><a class="reference internal" href="grafana_plots.html">Some useful Grafana plots</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="components/metrics.html">Metrics collection with Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="components/dashboards.html">Operational Dashboards with Grafana</a></li>
<li class="toctree-l1"><a class="reference internal" href="components/ingress.html">HTTPS ingress with nginx + kube-lego</a></li>
<li class="toctree-l1"><a class="reference internal" href="components/cloud.html">Cloud products</a></li>
<li class="toctree-l1"><a class="reference internal" href="components/matomo.html">Matomo (formerly Piwik) analytics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="analytics/events-archive.html">The Analytics Events Archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="analytics/cloud-costs.html">Cloud Costs Data</a></li>
</ul>
<p class="caption"><span class="caption-text">Incidents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2019-04-03-ingress-cordoned.html">2019-04-03, 30min outage during node pool upgrade</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2019-03-24-r2d-upgrade.html">2019-03-24, repo2docker upgrade and docker image cache wipe</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2019-02-20-no-logs.html">incident date: 2019-02-20, kubectl logs unavailable</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-07-30-jupyterlab-build-cpu-saturate.html">2018-07-30 JupyterLab builds saturate BinderHub CPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-07-08-podsnips-aplenty.html">2018-07-08, too many pods</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-04-18-cull-flood.html">2018-04-18, Culler flood</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-03-31-server-start-fail.html">2018-03-31, Server launch failures</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-03-26-no-space-left.html">2018-03-26, “no space left on device”</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-03-13-PVC-hub-locked.html">2018-03-13, PVC for hub is locked</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-02-22-nginx-down.html">2018-02-22 NGINX crash</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-02-20-jupyterlab-announcement.html">2018-02-20, JupyterLab Announcement swamps Binder</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-02-12-launch-fail.html">2018-02-12, Hub Launch Fail</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-01-18-reddit-hug.html">2018-01-18, reddit hugs mybinder</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-01-18-ssl-outdated.html">2018-01-11, Warning from letsencrypt about outdated SSL certificate</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-01-17-ubuntu-upgrade.html">2018-01-17, Emergency Aardvark bump</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2018-01-04-failed-staging-deploy.html">2018-01-04, Failed deploy to staging</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2017-11-30-oom-proxy.html">2017-11-30 4:23PM PST, OOM (Out of Memory) Proxy</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2017-10-17-cluster-full.html">2017-10-17, Cluster Full</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2017-09-29-504.html">2017-09-29, 504</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/2017-09-27-hub-403.html">2017-09-27, Hub 403</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/template-incident-report.html">Template for reports</a></li>
<li class="toctree-l1"><a class="reference internal" href="incident-reports/template-incident-report.html#incident-date-yyyy-mm-dd-incident-name">{{ incident date: yyyy-mm-dd }}, {{ incident name }}</a></li>
</ul>


<div class="relations">
<h3>Navigation</h3>
<ul>
  <li><a href="index.html">Documentation Home</a><ul>
  <li><a href="deployment/what.html" title="Previous">Previous topic</a></li>
  <li><a href="command_snippets.html" title="Next">Next topic</a></li>
  </ul>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/common_problems.md.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
        <form class="search" action="search.html" method="get">
            <input type="text" name="q" placeholder="Quick Search" aria-labelledby="searchlabel" />
            <input type="submit" value="Go" />
        </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017 - 2019, Binder Team.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/common_problems.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>